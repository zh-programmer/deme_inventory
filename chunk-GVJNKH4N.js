import{c as h,e as c,g as b,h as v}from"./chunk-GCSYRHVK.js";import{f as a}from"./chunk-EQDQRRRY.js";function g(d,e,i){return a(this,null,function*(){let t;return Promise.race([d,new Promise((s,n)=>{t=setTimeout(()=>n(i),e)})]).finally(()=>clearTimeout(t))})}var w=class extends h{constructor(){super(...arguments),this.deviceMap=new Map,this.discoveredDevices=new Map,this.scan=null,this.DEFAULT_CONNECTION_TIMEOUT=1e4,this.onAdvertisementReceivedCallback=this.onAdvertisementReceived.bind(this),this.onDisconnectedCallback=this.onDisconnected.bind(this),this.onCharacteristicValueChangedCallback=this.onCharacteristicValueChanged.bind(this)}initialize(){return a(this,null,function*(){if(typeof navigator>"u"||!navigator.bluetooth)throw this.unavailable("Web Bluetooth API not available in this browser.");if(!(yield navigator.bluetooth.getAvailability()))throw this.unavailable("No Bluetooth radio available.")})}isEnabled(){return a(this,null,function*(){return{value:!0}})}requestEnable(){return a(this,null,function*(){throw this.unavailable("requestEnable is not available on web.")})}enable(){return a(this,null,function*(){throw this.unavailable("enable is not available on web.")})}disable(){return a(this,null,function*(){throw this.unavailable("disable is not available on web.")})}startEnabledNotifications(){return a(this,null,function*(){})}stopEnabledNotifications(){return a(this,null,function*(){})}isLocationEnabled(){return a(this,null,function*(){throw this.unavailable("isLocationEnabled is not available on web.")})}openLocationSettings(){return a(this,null,function*(){throw this.unavailable("openLocationSettings is not available on web.")})}openBluetoothSettings(){return a(this,null,function*(){throw this.unavailable("openBluetoothSettings is not available on web.")})}openAppSettings(){return a(this,null,function*(){throw this.unavailable("openAppSettings is not available on web.")})}setDisplayStrings(){return a(this,null,function*(){})}requestDevice(e){return a(this,null,function*(){let i=this.getFilters(e),t=yield navigator.bluetooth.requestDevice({filters:i.length?i:void 0,optionalServices:e?.optionalServices,acceptAllDevices:i.length===0});return this.deviceMap.set(t.id,t),this.getBleDevice(t)})}requestLEScan(e){return a(this,null,function*(){this.requestBleDeviceOptions=e;let i=this.getFilters(e);yield this.stopLEScan(),this.discoveredDevices=new Map,navigator.bluetooth.removeEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),navigator.bluetooth.addEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),this.scan=yield navigator.bluetooth.requestLEScan({filters:i.length?i:void 0,acceptAllAdvertisements:i.length===0,keepRepeatedDevices:e?.allowDuplicates})})}onAdvertisementReceived(e){var i,t;let s=e.device.id;if(this.deviceMap.set(s,e.device),!this.discoveredDevices.has(s)||!((i=this.requestBleDeviceOptions)===null||i===void 0)&&i.allowDuplicates){this.discoveredDevices.set(s,!0);let r=this.getBleDevice(e.device),o={device:r,localName:r.name,rssi:e.rssi,txPower:e.txPower,manufacturerData:v(e.manufacturerData),serviceData:v(e.serviceData),uuids:(t=e.uuids)===null||t===void 0?void 0:t.map(b)};this.notifyListeners("onScanResult",o)}}stopLEScan(){return a(this,null,function*(){var e;!((e=this.scan)===null||e===void 0)&&e.active&&this.scan.stop(),this.scan=null})}getDevices(e){return a(this,null,function*(){return{devices:(yield navigator.bluetooth.getDevices()).filter(s=>e.deviceIds.includes(s.id)).map(s=>(this.deviceMap.set(s.id,s),this.getBleDevice(s)))}})}getConnectedDevices(e){return a(this,null,function*(){return{devices:(yield navigator.bluetooth.getDevices()).filter(s=>{var n;return(n=s.gatt)===null||n===void 0?void 0:n.connected}).map(s=>(this.deviceMap.set(s.id,s),this.getBleDevice(s)))}})}getBondedDevices(){return a(this,null,function*(){return{}})}connect(e){return a(this,null,function*(){var i,t;let s=this.getDeviceFromMap(e.deviceId);s.removeEventListener("gattserverdisconnected",this.onDisconnectedCallback),s.addEventListener("gattserverdisconnected",this.onDisconnectedCallback);let n=Symbol();if(s.gatt===void 0)throw new Error("No gatt server available.");try{let r=(i=e.timeout)!==null&&i!==void 0?i:this.DEFAULT_CONNECTION_TIMEOUT;yield g(s.gatt.connect(),r,n)}catch(r){throw yield(t=s.gatt)===null||t===void 0?void 0:t.disconnect(),r===n?new Error("Connection timeout"):r}})}onDisconnected(e){let t=`disconnected|${e.target.id}`;this.notifyListeners(t,null)}createBond(e){return a(this,null,function*(){throw this.unavailable("createBond is not available on web.")})}isBonded(e){return a(this,null,function*(){throw this.unavailable("isBonded is not available on web.")})}disconnect(e){return a(this,null,function*(){var i;(i=this.getDeviceFromMap(e.deviceId).gatt)===null||i===void 0||i.disconnect()})}getServices(e){return a(this,null,function*(){var i,t;let s=(t=yield(i=this.getDeviceFromMap(e.deviceId).gatt)===null||i===void 0?void 0:i.getPrimaryServices())!==null&&t!==void 0?t:[],n=[];for(let r of s){let o=yield r.getCharacteristics(),u=[];for(let l of o)u.push({uuid:l.uuid,properties:this.getProperties(l),descriptors:yield this.getDescriptors(l)});n.push({uuid:r.uuid,characteristics:u})}return{services:n}})}getDescriptors(e){return a(this,null,function*(){try{return(yield e.getDescriptors()).map(t=>({uuid:t.uuid}))}catch{return[]}})}getProperties(e){return{broadcast:e.properties.broadcast,read:e.properties.read,writeWithoutResponse:e.properties.writeWithoutResponse,write:e.properties.write,notify:e.properties.notify,indicate:e.properties.indicate,authenticatedSignedWrites:e.properties.authenticatedSignedWrites,reliableWrite:e.properties.reliableWrite,writableAuxiliaries:e.properties.writableAuxiliaries}}getCharacteristic(e){return a(this,null,function*(){var i;let t=yield(i=this.getDeviceFromMap(e.deviceId).gatt)===null||i===void 0?void 0:i.getPrimaryService(e?.service);return t?.getCharacteristic(e?.characteristic)})}getDescriptor(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e);return i?.getDescriptor(e?.descriptor)})}discoverServices(e){return a(this,null,function*(){throw this.unavailable("discoverServices is not available on web.")})}getMtu(e){return a(this,null,function*(){throw this.unavailable("getMtu is not available on web.")})}requestConnectionPriority(e){return a(this,null,function*(){throw this.unavailable("requestConnectionPriority is not available on web.")})}readRssi(e){return a(this,null,function*(){throw this.unavailable("readRssi is not available on web.")})}read(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e);return{value:yield i?.readValue()}})}write(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e),t;typeof e.value=="string"?t=c(e.value):t=e.value,yield i?.writeValueWithResponse(t)})}writeWithoutResponse(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e),t;typeof e.value=="string"?t=c(e.value):t=e.value,yield i?.writeValueWithoutResponse(t)})}readDescriptor(e){return a(this,null,function*(){let i=yield this.getDescriptor(e);return{value:yield i?.readValue()}})}writeDescriptor(e){return a(this,null,function*(){let i=yield this.getDescriptor(e),t;typeof e.value=="string"?t=c(e.value):t=e.value,yield i?.writeValue(t)})}startNotifications(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e);i?.removeEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),i?.addEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),yield i?.startNotifications()})}onCharacteristicValueChanged(e){var i,t;let s=e.target,n=`notification|${(i=s.service)===null||i===void 0?void 0:i.device.id}|${(t=s.service)===null||t===void 0?void 0:t.uuid}|${s.uuid}`;this.notifyListeners(n,{value:s.value})}stopNotifications(e){return a(this,null,function*(){let i=yield this.getCharacteristic(e);yield i?.stopNotifications()})}getFilters(e){var i;let t=[];for(let s of(i=e?.services)!==null&&i!==void 0?i:[])t.push({services:[s],name:e?.name,namePrefix:e?.namePrefix});return(e?.name||e?.namePrefix)&&t.length===0&&t.push({name:e.name,namePrefix:e.namePrefix}),t}getDeviceFromMap(e){let i=this.deviceMap.get(e);if(i===void 0)throw new Error('Device not found. Call "requestDevice", "requestLEScan" or "getDevices" first.');return i}getBleDevice(e){var i;return{deviceId:e.id,name:(i=e.name)!==null&&i!==void 0?i:void 0}}};export{w as BluetoothLeWeb};
